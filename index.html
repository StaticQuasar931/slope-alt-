<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Canonical only -->
  <link rel="canonical" href="https://staticquasar931.github.io/slope/" />

  <title>Slope Alt Safe Build | StaticQuasar931</title>

  <!-- Favicon and logos (images only) -->
  <link rel="icon" href="https://res.cloudinary.com/dlq5fztla/image/upload/v1760301648/slope_Staticquasar931_stable_agqxto.png" />
  <meta property="og:image" content="https://res.cloudinary.com/dlq5fztla/image/upload/v1760301648/slope_Staticquasar931_stable_agqxto.png" />

  <!-- Strict but practical CSP to hard block external scripts and calls (including id.net) while allowing local Unity + Cloudinary images -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval';
    connect-src 'self' blob: data:;
    img-src 'self' https://res.cloudinary.com data:;
    style-src 'self' 'unsafe-inline';
    font-src 'self' data:;
    media-src 'none';
    frame-src 'none';
    worker-src 'self' blob:;
    base-uri 'self';
    form-action 'self';
  ">

  <!-- Paranoid id.net blocker MUST run before any other script or Unity boot -->
  <script>
    (function () {
      try {
        const IDNET_RX = /(^|\/\/)id\.net\/api\/user_data/i;

        function isBadScript(node) {
          if (!node || node.tagName !== 'SCRIPT') return false;
          const src = String(node.src || '');
          return IDNET_RX.test(src);
        }

        function blockScript(node, reason) {
          try {
            if (isBadScript(node)) {
              console.warn('[SQ] Blocked id.net script via', reason, node.src || '(inline)');
              node.remove && node.remove();
              return true;
            }
          } catch (e) {}
          return false;
        }

        // Patch DOM insertion
        const ap = Node.prototype.appendChild;
        Node.prototype.appendChild = function (n) { if (blockScript(n, 'appendChild')) return n; return ap.call(this, n); };

        const ib = Node.prototype.insertBefore;
        Node.prototype.insertBefore = function (n, r) { if (blockScript(n, 'insertBefore')) return n; return ib.call(this, n, r); };

        const rp = Node.prototype.replaceChild;
        Node.prototype.replaceChild = function (n, o) { if (blockScript(n, 'replaceChild')) return n; return rp.call(this, n, o); };

        // Block setting src attribute on scripts
        try {
          const desc = Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype, 'src');
          if (desc && desc.set) {
            Object.defineProperty(HTMLScriptElement.prototype, 'src', {
              configurable: true,
              enumerable: desc.enumerable,
              get: desc.get,
              set: function (v) {
                if (IDNET_RX.test(String(v || ''))) {
                  console.warn('[SQ] Blocked id.net script src set', v);
                  return;
                }
                return desc.set.call(this, v);
              }
            });
          }
        } catch (e) {}

        // Intercept setAttribute on any element setting a script src
        const sa = Element.prototype.setAttribute;
        Element.prototype.setAttribute = function (name, value) {
          try {
            if (this.tagName === 'SCRIPT' && String(name).toLowerCase() === 'src' && IDNET_RX.test(String(value || ''))) {
              console.warn('[SQ] Blocked id.net via setAttribute', value);
              return;
            }
          } catch (e) {}
          return sa.call(this, name, value);
        };

        // Scrub document.write / writeln injections
        try {
          const W = document.write.bind(document);
          const WL = document.writeln.bind(document);
          const strip = s => typeof s === 'string'
            ? s.replace(/<script[^>]+src=["'][^"']*id\.net\/api\/user_data[^"']*["'][^>]*>\s*<\/script>/ig, '')
            : s;
          document.write = html => W(strip(html));
          document.writeln = html => WL(strip(html));
        } catch (e) {}

        // Block fetch to id.net
        const ofetch = window.fetch;
        window.fetch = function (input, init) {
          try {
            const url = typeof input === 'string' ? input : (input && input.url) || '';
            if (IDNET_RX.test(String(url || ''))) {
              console.warn('[SQ] Blocked id.net fetch', url);
              return Promise.resolve(new Response('{"status":"blocked"}', { status: 200, headers: { 'Content-Type': 'application/json' } }));
            }
          } catch (e) {}
          return ofetch.apply(this, arguments);
        };

        // Block XHR to id.net
        const oopen = XMLHttpRequest.prototype.open;
        const osend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.open = function (method, url) {
          this.__sq_block__ = IDNET_RX.test(String(url || ''));
          this.__sq_url__ = url;
          return oopen.apply(this, arguments);
        };
        XMLHttpRequest.prototype.send = function (body) {
          if (this.__sq_block__) {
            console.warn('[SQ] Blocked id.net XHR', this.__sq_url__);
            const self = this;
            setTimeout(function () {
              try {
                self.readyState = 4; self.status = 200; self.responseText = '{"status":"blocked"}';
                self.onload && self.onload();
                self.onreadystatechange && self.onreadystatechange();
              } catch (e) {}
            }, 0);
            return;
          }
          return osend.apply(this, arguments);
        };
      } catch (e) {
        console.error('[SQ] Blocker failed to initialize', e);
      }
    })();
  </script>

  <!-- Minimal styles for fullscreen game and fast loader -->
  <style>
    :root{
      --brand:#5ee1ff; --brand2:#9bffb7;
      --bg:#101218; --bg2:#0a0c12;
      --text:#eaf6ff; --muted:#b8d3ff;
      --shadow:0 8px 28px rgba(0,0,0,.45);
      --green:#7aff8a;
    }

    html, body { height:100%; margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2)); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden; }

    /* Game container */
    #gameContainer { position:fixed; inset:0; width:100vw; height:100vh; background:transparent; }

    /* Static Menu top left */
    #staticMenu {
      position:fixed; top:12px; left:12px; z-index:9;
      padding:10px 14px; border-radius:12px;
      background:linear-gradient(135deg, rgba(20,22,30,.92), rgba(20,22,30,.6));
      border:1px solid rgba(94,225,255,.35);
      box-shadow:0 0 12px rgba(94,225,255,.45), var(--shadow);
      backdrop-filter: blur(8px);
      font-weight:800; font-size:14px;
    }
    #staticMenu a { color: var(--brand); text-decoration: none; }

    /* Loader cover */
    #loaderCover {
      position:fixed; inset:0; z-index:10;
      background:radial-gradient(1100px 700px at 50% 40%, #1a2130 0%, #0d0f14 60%, #090b10 100%);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; text-align:center;
    }
    .logo-row { display:flex; gap:18px; align-items:center; justify-content:center; }
    .sq-logo, .unity-logo {
      width:92px; height:92px; border-radius:16px; overflow:hidden; background:#0b0d12;
      display:flex; align-items:center; justify-content:center; box-shadow:0 10px 34px rgba(94,225,255,.25);
    }
    .sq-logo img { width:100%; height:100%; object-fit:cover; }
    .unity-logo img { width:82%; height:82%; object-fit:contain; background:transparent !important; opacity:.92; }

    .intro .title { font-weight:1000; letter-spacing:.3px; font-size:18px; color:#d7ecff; }
    .intro .subtitle { font-weight:800; letter-spacing:.3px; font-size:15px; color:#c9e5ff; opacity:.9; }

    .loader-bar {
      position:relative; width:min(720px,92vw); height:26px; border-radius:13px; overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10), inset 0 6px 12px rgba(0,0,0,.25), var(--shadow);
      margin-inline:auto;
    }
    .loader-fill {
      height:100%; width:1%;
      background:
        linear-gradient(90deg, rgba(255,255,255,.25) 0%, rgba(255,255,255,0) 35%),
        linear-gradient(90deg, var(--brand), var(--brand2));
      transition: width .08s linear;
    }
    .loader-meta {
      width:min(720px,92vw); margin-inline:auto;
      display:flex; justify-content:space-between; align-items:center;
      color:var(--muted); font-weight:700; font-variant-numeric:tabular-nums; letter-spacing:.3px;
      text-shadow:0 1px 0 rgba(0,0,0,.35);
    }

    /* Tips bottom left */
    .tip {
      position:fixed; left:14px; bottom:16px; max-width:min(560px, 80vw);
      color:#cfe1ff; font-size:13px; line-height:1.35;
      background:rgba(15,18,28,.6); padding:10px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); z-index:10;
    }

    .coverHide { animation: coverHide .25s ease forwards; }
    @keyframes coverHide { to { opacity:0; visibility:hidden } }
  </style>

  <!-- Local Unity runtime and helper scripts -->
  <script src="UnityLoader.js"></script>
  <script src="tips.js" defer></script>
</head>
<body>
  <!-- Leave warning -->
  <script>
    window.onbeforeunload = () => "Are you sure you want to leave? Your progress may not be saved.";
  </script>

  <!-- Static Menu (top left) -->
  <div id="staticMenu" role="region" aria-label="StaticQuasar menu">
    <a href="https://sites.google.com/view/staticquasar931/gm3z" target="_blank" rel="noopener">More Unblocked Games by Static</a>
  </div>

  <!-- Loader -->
  <div id="loaderCover" role="status" aria-live="polite">
    <div class="logo-row">
      <div class="sq-logo">
        <img src="https://res.cloudinary.com/dcsrqennd/image/upload/v1760208794/My%20Brand/Static_pfp_2_nqzjkd.jpg" alt="StaticQuasar931 logo">
      </div>
      <div class="unity-logo">
        <img src="https://res.cloudinary.com/dlq5fztla/image/upload/v1760307222/unity_i4qjdf.png" alt="Unity logo">
      </div>
    </div>

    <div class="intro">
      <div class="title">StaticQuasar931 Presents</div>
      <div class="subtitle">Slope Alt Safe Build</div>
    </div>

    <div class="loader-bar"><div class="loader-fill" id="loaderFill"></div></div>
    <div class="loader-meta">
      <small id="loaderMsg">Initializing WebGL</small>
      <div id="loaderPct">1%</div>
    </div>
  </div>

  <!-- Tips bottom left -->
  <div class="tip" id="loaderTip">Loading tipâ€¦</div>

  <!-- Unity game -->
  <div id="gameContainer"></div>

  <script>
    // Fit canvas to viewport
    function fitGame(){
      const el = document.getElementById("gameContainer");
      if (!el) return;
      const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      el.style.width  = window.innerWidth + "px";
      el.style.height = h + "px";
    }
    addEventListener("resize", fitGame, {passive:true});
    if (window.visualViewport) window.visualViewport.addEventListener("resize", fitGame, {passive:true});

    // Tips rotation using tips.js if present
    (function(){
      const tipEl = document.getElementById("loaderTip");
      if (!tipEl) return;
      function list(){
        if (Array.isArray(window.SQ_TIPS) && window.SQ_TIPS.length) return window.SQ_TIPS.slice();
        return [
          "Use A and D or arrow keys for gentle corrections.",
          "Short taps beat hard turns.",
          "Center first, then correct.",
          "Chromebook trackpad works best with short swipes."
        ];
      }
      let arr = list();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      let idx = 0;
      const show = () => { tipEl.textContent = arr[idx % arr.length]; idx++; };
      show();
      const id = setInterval(show, 10000);
      window.__sq_stop_tip_cycle__ = () => clearInterval(id);
    })();

    // Simple progress handler independent of UnityProgress.js
    (function(){
      const cover = document.getElementById("loaderCover");
      const fill  = document.getElementById("loaderFill");
      const pctEl = document.getElementById("loaderPct");
      const msgEl = document.getElementById("loaderMsg");

      let reported = 0.01;   // start at 1 percent
      let visual   = 0.01;
      let runtimeReady = false;
      let lastUpdate = performance.now();

      function normalizeProgress(p){
        if (typeof p === "number") return p;
        if (p && typeof p.progress === "number") return p.progress;
        if (p && typeof p.loaded === "number" && typeof p.total === "number" && p.total > 0) return p.loaded / p.total;
        return 0;
      }

      window.SQProgress = function(_game, p){
        const n = normalizeProgress(p);
        if (n > reported){
          reported = Math.min(1, n);
          lastUpdate = performance.now();
          msgEl.textContent = reported < 1 ? "Loading assets" : "Starting";
        }
      };

      function loop(){
        const now = performance.now();
        const dt = Math.min(0.05, (loop.prev ? (now - loop.prev)/1000 : 0));
        loop.prev = now;

        const diff = reported - visual;
        if (diff > 0) visual += Math.min(diff, (diff > 0.15 ? 0.6 : diff > 0.05 ? 0.35 : 0.2) * (dt * 60));

        // Anti stall while waiting for runtime
        if (!runtimeReady && now - lastUpdate > 2500){
          const cap = Math.min(0.97, reported + 0.02);
          visual = Math.min(cap, visual + 0.003);
          msgEl.textContent = "Network is slow. Please wait";
        }

        const pct = Math.max(1, Math.min(100, Math.round(visual * 100)));
        fill.style.width = pct + "%";
        pctEl.textContent = pct + "%";

        if (runtimeReady && visual >= 0.999){
          cover.classList.add("coverHide");
          window.__sq_stop_tip_cycle__ && window.__sq_stop_tip_cycle__();
          return;
        }
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);

      // Start Unity using local manifest
      function startUnity(){
        fitGame();
        try{
          if (window.UnityLoader && typeof UnityLoader.instantiate === "function"){
            window.gameInstance = UnityLoader.instantiate("gameContainer", "slope_new.json", {
              onProgress: window.SQProgress,
              Module: {
                onRuntimeInitialized: function(){
                  reported = 1;
                  runtimeReady = true;
                  msgEl.textContent = "Ready";
                }
              }
            });

            // Watchdog: if Unity signals ready via Module flags, finish
            const t = setInterval(()=>{
              const gi = window.gameInstance;
              if (!gi) { clearInterval(t); return; }
              const m = gi.Module;
              const ready = m && (m.calledRun || m.runtimeInitialized);
              if (ready){ reported = 1; runtimeReady = true; clearInterval(t); }
            }, 500);
          } else {
            console.error("[SQ] UnityLoader.js not found or invalid");
            // Fail open to avoid black screen
            cover.classList.add("coverHide");
          }
        } catch (e){
          console.error("[SQ] Unity failed to start:", e);
          cover.classList.add("coverHide");
        }
      }
      if (document.readyState === "complete") startUnity();
      else window.addEventListener("load", startUnity);
    })();
  </script>
</body>
</html>
